{% extends 'base.html' %}
{% block title %} Dunistech Academy {% endblock title %}

{% block content %}

<div class="wrapper">
    {% include 'incs/sidenav.html' %}
    {% include 'incs/topnav.html' %}
    <div class="content-page">
        
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card card-transparent card-block card-stretch card-height border-none">
                        <div class="card-body p-0 mt-lg-2 mt-0">
                            <h3 class="mb-3" id="greet">Hi {{current_user.username}},</h3>
                            <p class="mb-0 mr-4 text-warning">
                                We keep track of key performance, business process &
                                Statistics.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="row">

                        <div class="col-lg-4 col-md-4">
                            <div class="card card-block card-stretch card-height">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-4 card-total-sale">
                                        <div class="icon iq-icon-box-2 bg-info-light">
                                            <img src="{{url_for('static', filename='images/product/1.png')}}"
                                                class="img-fluid" alt="image">
                                        </div>
                                        <div>
                                            <b class="mb-2">Identification</b>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary rounded-pill mt-2" 
                                    data-toggle="modal" data-user-id="{{ current_user.id }}"
                                    data-target="#idcard_modal">
                                        Click to view/download</button>
                                </div>
                            </div>
                        </div>


                        <div class="col-lg-4 col-md-4">
                            <div class="card card-block card-stretch card-height">

                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-4 card-total-sale">
                                        <div>
                                            <b class="mb-2">Total Attendance</b>
                                            <h4 id="totalAttendance">0</h4>
                                        </div>
                                    </div>

                                    <div class="custom-control custom-switch custom-switch-xl">
                                        <input type="checkbox" class="custom-control-input" id="customSwitch8">
                                        <label class="custom-control-label" for="customSwitch8"> </label>
                                    </div>
                                    <b id="attendance-text" class="text-secondary">Switch to clock out</b>
                                </div>
                                <div id="message" class="mt-3"></div>
                            </div>
                        </div>
                        {% for role in current_user.roles %}
                        {% if role.type in ["admin", "staff", "instructor"] %}
                        <div class="col-lg-4 col-md-4">
                            <div class="card card-block card-stretch card-height">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-4 card-total-sale">
                                        <div class="icon iq-icon-box-2 bg-info-light">
                                            <img src="{{url_for('static', filename='images/product/1.png')}}"
                                                class="img-fluid" alt="image">
                                        </div>
                                        <div>
                                            <b class="mb-2">Assigned tasks</b>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary rounded-pill mt-2" data-toggle="modal" 
                                    data-target="#taskModalScrollable">
                                        Click to view | 34</button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <!-------->
            </div>
            <!-- Page end  -->
        </div>
        
        <div class="container-fluid">
                <!-- Add this HTML snippet to your template file for adding and updating tasks -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
                            <div>
                                <h4 class="mb-3">Daily Task Record(s)</h4>
                                <p class="mb-0 text-warning">Filter-by date to see tasks marked for each day(s)</p>
                            </div>
                            <button id="add-task-button" class="btn btn-primary add-list">
                                <i class="las la-plus mr-3"></i>Record Task(s)
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="table-responsive rounded mb-3">
                            <table id="DataTables_Table_0" class="data-table table mb-0 
                            tbl-server-info">
                            {# note: `data-table` adding `s` will make cause the search bar to hide, yet to debug this #}
                            {#
                                <table class="data-tables table mb-0 tbl-server-info dataTable 
                                no-footer" id="DataTables_Table_0" role="grid" 
                                aria-describedby="DataTables_Table_0_info">#}

                                <thead class="bg-white text-uppercase">
                                    <tr class="ligth ligth-data">
                                        <th>S/N</th>
                                        <th>Tasks</th>
                                        <th>Status</th>
                                        <th>Time Stamp</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                
                                <tbody id="task-table-body" class="ligth-body">

                                    <tr id="original-task-row" class="d-none">
                                        <td></td>
                                        <td>
                                            {% for role in current_user.roles  %}
                                            {% if role.type == "student" %}
                                            <input id="assigned_task_select" type="text" class="form-control" 
                                            placeholder="What did you learn today?"> 
                                            {% else %}
                                            <select id="assigned_task_select" class="custom-select">
                                            {% for task in assigned_tasks_list %}
                                                <option value="{{task.detail}}">{{task.detail}}</option>
                                            {% endfor %}
                                            </select>
                                            {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            <select id="assigned_task_status"  class="custom-select">
                                                <option value="pending" selected>Pending</option>
                                                <option value="completed">Completed</option>
                                                <option value="on-going">On-going</option>
                                                <option value="stucked">Stucked</option>
                                                <option value="cancelled">Cancelled</option>
                                            </select>
                                        </td>
                                        <td><input type="date" class="form-control"></td>
                                        <td>
                                            <button class="btn btn-success" onclick="saveNewTask(this)">
                                                <i class="las la-plus mr-0"></i>
                                            </button>
                                            <button class="btn btn-warning" onclick="removeNewTaskRow(this)">
                                                <i class="ri-delete-bin-line mr-0"></i>
                                            </button>
                                        </td>
                                    </tr>

                                    {% for task in tasks_list %}
                                    <tr>
                                       
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            <input type="text" value="{{task.description}}" 
                                            data-task-id="{{task.id}}" onchange="updateTask(this)" class="form-control" 
                                            placeholder="New task description"> 
                                        </td>
                                        <td>
                                            <select class="custom-select" data-task-id="{{task.id}}" 
                                            onchange="updateTask(this)">
                                                {% for status in status_options %}
                                                <option value="{{ status }}" {% if task.status == status %} 
                                                selected {% endif %}>
                                                    {{ status|title }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="date" class="form-control"
                                            value="{{ task.timestamp }}" data-task-id="{{task.id}}" onchange="updateTask(this)"> 
                                        </td>
                                        <td>
                                            <button class="btn btn-warning" onclick="deleteTask({{ task.id }}, this)">Delete</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    <!-- Existing task rows will go here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </div>

    </div>

</div>

<!-- - modals---->
{% include "incs/response_modal.html" %}
{% include "incs/assigned_tasks_modal.html" %}
{% include "incs/attendance_modal.html" %}
{% include "incs/idcard_modal.html" %}
{% endblock content %}
{% block page_js %}

<script src="{{url_for('static', filename='js/libs/html2canvas.min.js')}}"></script>
<script src="{{url_for('static', filename='js/libs/jspdf.min.js')}}"></script>
<script src="{{url_for('static', filename='js/html2pdf.bundle.min.js')}}"></script>
<script src = "{{url_for('static', filename='js/assigned_task.js')}}"></script> 
{#<script src = "{{url_for('static', filename='js/attendance.js')}}"></script>#}
<script src = "{{url_for('static', filename='js/tasks.js')}}"></script>
<script>

    function checkStatus() {
        fetch('/attendance_status')
            .then(response => response.json())
            .then(data => {
                const switchControl = document.getElementById('customSwitch8');
                const attendanceText = document.getElementById('attendance-text');
                if (data.status === 'signed_in') {
                    switchControl.checked = true;
                    attendanceText.textContent = 'Switch to clock out';
                } else {
                    switchControl.checked = false;
                    attendanceText.textContent = 'Switch to clock in';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while checking status.', 'danger');
            });
    }

    function handleAttendance(isSigningIn) {
        const action = isSigningIn ? 'signin' : 'signout';

        fetch('/create_attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                //showMessage(data.message);
                //const attendanceText = document.getElementById('attendance-text');
                if (isSigningIn) {
                    //attendanceText.textContent = 'Switch to clock out';
                    showMessage(data.message, 'danger');
                } else {
                    //attendanceText.textContent = 'Switch to clock in';
                    showMessage(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred: ' + error.message, 'danger');
            });
    }

    document.addEventListener("DOMContentLoaded", function () {

        checkStatus();

        document.getElementById('customSwitch8').addEventListener('change', function () {
            handleAttendance(this.checked);
        });

    });

    function getTotalAttendance() {
        fetch('/total_attendance')
            .then(response => response.json())
            .then(data => {
                const totalAttendanceDiv = document.getElementById('totalAttendance');
                totalAttendanceDiv.textContent = `${data.total_attendance} days`;
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    document.addEventListener("DOMContentLoaded", function () {
        getTotalAttendance();
    });

    /*
    function loadUserIdCard(userId) {
        $.ajax({
          url: `/user/${userId}/id-details`,  // Adjust the URL to match your backend route
          type: 'GET',
          success: function(data) {
            // console.log(data);
            if (data.success) {
              $('#student-photo').attr('src', `/static/images/user/${data.user.photo || '1.png'}`);
              $('#student-name').text(data.user.name);
              $('#student-reg-num').append(` `+ data.user.reg_num);
              $('#student-course').append(` `+ data.user.course || '. . .');
              $('#student-batch').append(` `+ data.user.batch || '. . .'); // Assuming batch data is available
              $('#student-email').append(` `+ data.user.email);
              $('#student-phone').append(` `+ data.user.phone);
            } else {
              console.error('Failed to load user ID details:', data.error);
            }
          },
          error: function(xhr, status, error) {
            console.error('Error:', error);
          }
        });
      }
      
      // Example usage
      $(document).ready(function() {
        const userId = {{ current_user.id }}; // Adjust this to the current user's ID dynamically
        loadUserIdCard(userId);
      }); 

    $('#download-id-card').on('click', function() {
        var $this = $(this);
        $this.html('<i class="fa fa-circle-notch fa-spin fa-1x fa-fw"></i>');

        html2canvas(document.querySelector('.id-card')).then(function(canvas) {
            var imgData = canvas.toDataURL('image/png');
            var pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save('id_card.pdf');

            $this.html('Download');
        }).catch(function(error) {
            console.error('Error generating ID card:', error);
            $this.html('Download ID Card');
        });
    });
*/
/*
<h5 id="user-name" class="card-title text-center">.</h5>
                    <p id="user-category" class="card-text"><strong>Category:</strong> </p>
                    <p id="user-id-label" class="card-text"><strong></strong></p>
                    <p id="user-id-value" class="card-text"></p>
                    <p id="user-role" class="card-text"></p>
                    <p id="user-batch" class="card-text" style="display: none;"><strong>Batch:</strong> </p>
                    <p id="user-email" class="card-text"><strong>Email:</strong> </p>
                    <p id="user-phone" class="card-text"><strong>Phone:</strong> </p>*/
function loadUserIdCard(userId) {
    $.ajax({
        url: `/user/${userId}/id-details`, // Adjust the URL to match your backend route
        type: 'GET',
        success: function(data) {
            if (data.success) {
                const user = data.user;
                console.log(user)
                const photoPath = `/static/images/user/${user.photo || '1.png'}`;
                const logoPath = user.category === 'student'
                    ? '/static/images/logo/dunistech_academy.png' // Replace with the actual academy logo path
                    : '/static/images/logo/dunistech_logo.png'; // Replace with the actual company logo path

                // Update common details
                $('#user-photo').attr('src', photoPath);
                $('#id-logo').attr('src', logoPath); // Update logo based on category

                $('#user-name').text(user.name);

                $('#user-email strong').text('Email');
                $('#user-email small').text(user.email);

                $('#user-phone strong').text('Phone');
                $('#user-phone small').text(user.phone);

                // Handle category-specific fields
                switch (user.category) {
                    case 'user':
                    case 'staff':
                    case 'intern-staff':
                    case 'corper-staff':

                        $('#user-id-label strong').text('Staff ID');
                        $('#user-id-label small').text(user.reg_num);

                        $('#user-role strong').text(`Designation`);
                        $('#user-role small').text(`${user.designation}`);

                        $('#user-category strong').text(`category`);
                        $('#user-category small').text(`${user.category}`);

                        //$('#user-category').text(`Category: ${capitalize(user.category.replace('-', ' '))}`);
                        //$('#user-category').text(`Category: ${capitalize(user.category)}`);
                        break;

                    case 'customer':
                        $('#user-id-label').text('Customer ID:');
                        $('#user-id-value').text(user.reg_num || 'N/A');
                        $('#user-role').text('Loyalty Level: ' + (user.loyalty_level || 'Standard'));
                        $('#user-category').text('Category: Customer');
                        break;

                    case 'student':
                        $('#user-id-label strong').text('Registration:');
                        $('#user-id-label small').text(user.reg_num);

                        $('#user-role strong').text(`Course`);
                        $('#user-role small').text(`${user.course || 'N/A'}`);

                        $('#user-batch strong').text(`Batch`);
                        $('#user-batch small').text(`${user.batch || 'N/A'}`).show();

                        $('#user-category strong').text('Category');
                        $('#user-category small').text('Student');

                        break;

                    default:
                        console.warn('Unknown category', user.category);
                        $('#user-category strong').text('Category');
                        $('#user-category small').text('User');
                }

                // Hide batch field if not applicable
                if (user.category !== 'student') {
                    $('#user-batch').hide();
                }
            } else {
                console.error('Failed to load user ID details:', data.error);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}

// Capitalize helper function
function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// Example usage
$(document).ready(function() {
    const userId = {{ current_user.id }}; // Adjust this dynamically
    loadUserIdCard(userId);
});

$('#download-id-card').on('click', function() {
    const $this = $(this);
    $this.html('<i class="fa fa-circle-notch fa-spin fa-1x fa-fw"></i>');

    html2canvas(document.querySelector('.id-card')).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });

        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('id_card.pdf');

        $this.html('Download');
    }).catch(function(error) {
        console.error('Error generating ID card:', error);
        $this.html('Download ID Card');
    });
});

// Capitalize helper function
function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// Example usage
$(document).ready(function() {
    const userId = {{ current_user.id }}; // Adjust this dynamically
    loadUserIdCard(userId);
});

$('#download-id-card').on('click', function() {
    const $this = $(this);
    $this.html('<i class="fa fa-circle-notch fa-spin fa-1x fa-fw"></i>');

    html2canvas(document.querySelector('.id-card')).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });

        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('id_card.pdf');

        $this.html('Download');
    }).catch(function(error) {
        console.error('Error generating ID card:', error);
        $this.html('Download ID Card');
    });
});

</script>

{% endblock page_js %}